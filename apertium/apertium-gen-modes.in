#!/bin/bash

apertiumdir=@apertiumdir@

if [[ $# -lt 1 || $# -gt 3 || $1 = "-h" ]]; then
    cat >&2 <<EOF 
USAGE: $(basename $0) modes.xml 
       $(basename $0) modes.xml BASENAME
       $(basename $0) modes.xml --to INSTALLDIR

Creates all modes under the 'modes/' subdirectory of the directory of
modes.xml, and further creates copies of installable modes in the same
directory as modes.xml.

If only modes.xml is given, all files refer only to datafiles under
the same directory as modes.xml.

If only modes.xml and BASENAME are given, installable modes will refer
to datafiles in ${apertiumdir}/\${BASENAME}.

If three arguments are given, installable modes will refer to data
files in INSTALLDIR.

EOF
    exit 1
fi

xmlfile="$1"
if [[ ! -e "${xmlfile}" ]]; then
    echo "ERROR: '${xmlfile}' file not found"
    exit 1
fi
xmldir=$(cd $(dirname "${xmlfile}"); pwd)

case $# in
    1) installdir="${xmldir}";;
    2) installdir="${apertiumdir}/$2";;
    3) installdir="$3";;
esac

[[ -d "${xmldir}"/modes ]] || mkdir "${xmldir}"/modes

xmllint --dtdvalid "${apertiumdir}"/modes.dtd --noout "${xmlfile}" || exit $?

xsltproc --stringparam devdir "${xmldir}" \
	 --stringparam installdir "${installdir}" \
	 "${apertiumdir}"/modes2bash.xsl \
	 "${xmlfile}" |\
    awk -f "${apertiumdir}"/apertium-createmodes.awk
